# =============================================================================
# POCKET POS - PostgreSQL Configuration
# =============================================================================
# This configuration file is optimized for Docker container deployment
# with settings suitable for both development and production environments

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

# Listen on all addresses within the container
listen_addresses = '*'

# Port configuration (default: 5432)
port = 5432

# Maximum number of concurrent connections
max_connections = 200

# Connection timeout
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# =============================================================================
# MEMORY SETTINGS
# =============================================================================

# Shared memory buffer (25% of available RAM)
shared_buffers = 256MB

# Working memory for complex queries
work_mem = 4MB

# Memory for maintenance operations
maintenance_work_mem = 64MB

# Effective cache size (75% of available RAM)
effective_cache_size = 1GB

# =============================================================================
# WRITE AHEAD LOGGING (WAL)
# =============================================================================

# WAL level for replication
wal_level = replica

# WAL buffer size
wal_buffers = 16MB

# Maximum WAL size
max_wal_size = 1GB

# Minimum WAL size
min_wal_size = 80MB

# WAL writer delay
wal_writer_delay = 200ms

# Checkpoint settings
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min

# =============================================================================
# QUERY PLANNER
# =============================================================================

# Random page cost (SSD optimized)
random_page_cost = 1.1

# Sequential page cost
seq_page_cost = 1.0

# CPU tuple cost
cpu_tuple_cost = 0.01

# CPU index tuple cost
cpu_index_tuple_cost = 0.005

# CPU operator cost
cpu_operator_cost = 0.0025

# =============================================================================
# BACKGROUND WRITER
# =============================================================================

# Background writer delay
bgwriter_delay = 200ms

# Background writer LRU maxpages
bgwriter_lru_maxpages = 100

# Background writer LRU multiplier
bgwriter_lru_multiplier = 2.0

# =============================================================================
# AUTOVACUUM
# =============================================================================

# Enable autovacuum
autovacuum = on

# Autovacuum max workers
autovacuum_max_workers = 3

# Autovacuum naptime
autovacuum_naptime = 1min

# Autovacuum vacuum threshold
autovacuum_vacuum_threshold = 50

# Autovacuum analyze threshold
autovacuum_analyze_threshold = 50

# Autovacuum vacuum scale factor
autovacuum_vacuum_scale_factor = 0.2

# Autovacuum analyze scale factor
autovacuum_analyze_scale_factor = 0.1

# =============================================================================
# LOGGING
# =============================================================================

# Logging collector
logging_collector = on

# Log directory
log_directory = 'pg_log'

# Log filename pattern
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Log file mode
log_file_mode = 0600

# Log truncate on rotation
log_truncate_on_rotation = on

# Log rotation age
log_rotation_age = 1d

# Log rotation size
log_rotation_size = 100MB

# What to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000  # Log queries taking longer than 1 second

# Log connections and disconnections
log_connections = on
log_disconnections = on

# Log lock waits
log_lock_waits = on

# Log checkpoints
log_checkpoints = on

# Log temporary files
log_temp_files = 10MB

# Log statement
log_statement = 'ddl'  # Log DDL statements

# Log line prefix
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# =============================================================================
# STATISTICS
# =============================================================================

# Track activities
track_activities = on

# Track counts
track_counts = on

# Track IO timing
track_io_timing = on

# Track functions
track_functions = all

# Statistics target
default_statistics_target = 100

# =============================================================================
# EXTENSIONS
# =============================================================================

# Shared preload libraries
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# =============================================================================
# SECURITY
# =============================================================================

# SSL configuration (disabled for development, enable for production)
ssl = off
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_ca_file = 'ca.crt'

# Password encryption
password_encryption = scram-sha-256

# =============================================================================
# LOCALE AND FORMATTING
# =============================================================================

# Locale settings
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# Timezone
timezone = 'UTC'

# Date style
datestyle = 'iso, mdy'

# Interval style
intervalstyle = 'postgres'

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Synchronous commit (can be disabled for better performance in development)
synchronous_commit = on

# Full page writes
full_page_writes = on

# WAL compression
wal_compression = on

# Huge pages
huge_pages = try

# Temp buffers
temp_buffers = 8MB

# Max files per process
max_files_per_process = 1000

# =============================================================================
# REPLICATION (for future use)
# =============================================================================

# Maximum WAL senders
max_wal_senders = 3

# Maximum replication slots
max_replication_slots = 3

# WAL keep segments
wal_keep_size = 128MB

# Hot standby
hot_standby = on

# Hot standby feedback
hot_standby_feedback = off

# =============================================================================
# DEVELOPMENT SPECIFIC SETTINGS
# =============================================================================
# These settings are optimized for development environments
# For production, consider adjusting based on your specific requirements

# Enable detailed query logging in development
# log_statement = 'all'  # Uncomment for development debugging
# log_min_duration_statement = 0  # Log all statements in development

# Disable fsync for development (NEVER use in production)
# fsync = off  # Uncomment only for development

# =============================================================================
# CUSTOM SETTINGS
# =============================================================================

# Custom variable for application identification
# Note: custom_variable_classes was removed in PostgreSQL 9.2+

# Application name
application_name = 'PocketPOS'

# =============================================================================
# NOTES
# =============================================================================
# 
# 1. This configuration is optimized for a container with 2-4GB RAM
# 2. For production, ensure proper SSL configuration
# 3. Monitor and adjust memory settings based on actual usage
# 4. Consider using connection pooling (PgBouncer) for high-traffic scenarios
# 5. Regular VACUUM and ANALYZE operations are handled by autovacuum
# 6. For high-availability setups, configure streaming replication
# 7. Always backup your data regularly
# 
# =============================================================================